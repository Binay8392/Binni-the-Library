<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binni the Library - Smart Library Management System</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Landing Page -->
    <div id="landing-page" class="page">
        <header class="landing-header">
            <div class="container">
                <div class="header-content">
                    <h1 class="library-title">
                        <i class="fas fa-brain"></i>
                        Binni the Library
                    </h1>
                    <p class="library-subtitle">AI-Powered Smart Library Management System</p>
                </div>
            </div>
        </header>
        
        <main class="landing-main">
            <div class="container">
                <div class="role-selection">
                    <h2>Select Your Role</h2>
                    <div class="role-cards">
                        <div class="role-card" data-role="student">
                            <div class="role-icon">
                                <i class="fas fa-user-graduate"></i>
                            </div>
                            <h3>Student</h3>
                            <p>Browse books, download PDFs, request offline issues</p>
                            <button class="btn btn--primary">Login as Student</button>
                        </div>
                        
                        <div class="role-card" data-role="faculty">
                            <div class="role-icon">
                                <i class="fas fa-chalkboard-teacher"></i>
                            </div>
                            <h3>Faculty</h3>
                            <p>Upload PDFs, access digital repository, manage resources</p>
                            <button class="btn btn--primary">Login as Faculty</button>
                        </div>
                        
                        <div class="role-card" data-role="librarian">
                            <div class="role-icon">
                                <i class="fas fa-user-shield"></i>
                            </div>
                            <h3>Librarian</h3>
                            <p>Manage catalog, approve requests, track fines, analytics</p>
                            <button class="btn btn--primary">Login as Librarian</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="login-title">Login</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="login-form">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="login-email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="login-password" required>
                    </div>
                    <button type="submit" class="btn btn--primary btn--full-width">Login</button>
                </form>
                <div id="login-error" class="error-message hidden"></div>
                
                <!-- Demo Credentials Helper -->
                <div style="margin-top: 16px; padding: 12px; background: var(--color-bg-1); border-radius: var(--radius-base); font-size: 12px;">
                    <strong>Demo Credentials:</strong><br>
                    Student: john.student@iem.edu / student123<br>
                    Faculty: sarah.faculty@iem.edu / faculty123<br>
                    Librarian: mike.librarian@iem.edu / librarian123
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Pages -->
    <div id="dashboard-page" class="page hidden">
        <!-- Navigation -->
        <nav class="dashboard-nav">
            <div class="nav-brand">
                <i class="fas fa-brain"></i>
                Binni the Library
            </div>
            <div class="nav-links">
                <button class="nav-link active" data-section="home">
                    <i class="fas fa-home"></i> Dashboard
                </button>
                <button class="nav-link" data-section="books">
                    <i class="fas fa-book"></i> Books
                </button>
                <button class="nav-link" data-section="my-books" id="my-books-nav">
                    <i class="fas fa-bookmark"></i> My Books
                </button>
                <button class="nav-link" data-section="upload" id="upload-nav">
                    <i class="fas fa-upload"></i> Upload
                </button>
                <button class="nav-link" data-section="admin" id="admin-nav">
                    <i class="fas fa-cog"></i> Admin
                </button>
            </div>
            <div class="nav-user">
                <span id="user-name">User</span>
                <button class="btn btn--secondary btn--sm" id="logout-btn">Logout</button>
            </div>
        </nav>

        <!-- Dashboard Content -->
        <main class="dashboard-content">
            <!-- Home Section -->
            <section id="home-section" class="dashboard-section active">
                <div class="container">
                    <div class="dashboard-header">
                        <h1>Welcome to Your Dashboard</h1>
                        <p id="dashboard-subtitle">Manage your library resources efficiently</p>
                    </div>
                    
                    <div class="dashboard-stats">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="total-books">0</h3>
                                <p>Total Books</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="digital-books">0</h3>
                                <p>Digital Books</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-bookmark"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="issued-books">0</h3>
                                <p>Books Issued</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="pending-requests">0</h3>
                                <p>Pending Requests</p>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="dashboard-widget">
                            <h3>Recent Books</h3>
                            <div id="recent-books" class="book-list"></div>
                        </div>
                        
                        <div class="dashboard-widget">
                            <h3>AI Recommendations</h3>
                            <div id="recommendations" class="book-list"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Books Section -->
            <section id="books-section" class="dashboard-section">
                <div class="container">
                    <div class="section-header">
                        <h2>Library Catalog</h2>
                        <div class="search-controls">
                            <div class="search-bar">
                                <input type="text" id="book-search" class="form-control" placeholder="Search books by title, author, ISBN...">
                                <button class="btn btn--primary" id="search-btn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <select id="genre-filter" class="form-control">
                                <option value="">All Genres</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Literature">Literature</option>
                                <option value="Mathematics">Mathematics</option>
                                <option value="Economics">Economics</option>
                                <option value="Chemistry">Chemistry</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="books-grid" class="books-grid"></div>
                </div>
            </section>

            <!-- My Books Section -->
            <section id="my-books-section" class="dashboard-section">
                <div class="container">
                    <h2>My Books</h2>
                    <div id="my-books-content">
                        <div class="my-books-tabs">
                            <button class="tab-btn active" data-tab="issued">Issued Books</button>
                            <button class="tab-btn" data-tab="history">Reading History</button>
                            <button class="tab-btn" data-tab="requests">My Requests</button>
                        </div>
                        
                        <div id="issued-tab" class="tab-content active">
                            <div id="issued-books-list" class="books-list"></div>
                        </div>
                        
                        <div id="history-tab" class="tab-content">
                            <div id="reading-history-list" class="books-list"></div>
                        </div>
                        
                        <div id="requests-tab" class="tab-content">
                            <div id="my-requests-list" class="requests-list"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Upload Section -->
            <section id="upload-section" class="dashboard-section">
                <div class="container">
                    <h2>Upload New Book</h2>
                    <div class="upload-form-container">
                        <form id="upload-form" class="upload-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Title</label>
                                    <input type="text" class="form-control" id="book-title" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Author</label>
                                    <input type="text" class="form-control" id="book-author" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">ISBN</label>
                                    <input type="text" class="form-control" id="book-isbn" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Genre</label>
                                    <select class="form-control" id="book-genre" required>
                                        <option value="">Select Genre</option>
                                        <option value="Computer Science">Computer Science</option>
                                        <option value="Literature">Literature</option>
                                        <option value="Mathematics">Mathematics</option>
                                        <option value="Economics">Economics</option>
                                        <option value="Chemistry">Chemistry</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Publication Year</label>
                                    <input type="number" class="form-control" id="book-year" min="1900" max="2025" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Copies</label>
                                    <input type="number" class="form-control" id="book-copies" min="0" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="book-description" rows="3" required></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Upload PDF File</label>
                                <input type="file" class="form-control" id="book-pdf-file" accept=".pdf">
                                <small class="form-text text-muted">Upload a PDF file directly (recommended)</small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Or Book Resource Link (Google Drive)</label>
                                <input type="url" class="form-control" id="book-drive-link" placeholder="https://drive.google.com/file/d/..." pattern="https://drive\.google\.com/.*">
                                <small class="form-text text-muted">Alternatively, paste the Google Drive sharing link for the book PDF/resource</small>
                            </div>

                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="is-public-link" checked>
                                    <label for="is-public-link">Link is accessible to anyone with the link</label>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn--primary btn--full-width">Upload Book Info</button>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Admin Section -->
            <section id="admin-section" class="dashboard-section">
                <div class="container">
                    <h2>Admin Panel</h2>
                    <div class="admin-tabs">
                        <button class="admin-tab-btn active" data-tab="requests">Pending Requests</button>
                        <button class="admin-tab-btn" data-tab="overdue">Overdue Books</button>
                        <button class="admin-tab-btn" data-tab="analytics">Analytics</button>
                        <button class="admin-tab-btn" data-tab="users">User Management</button>
                    </div>
                    
                    <div id="admin-requests" class="admin-tab-content active">
                        <h3>Pending Issue Requests</h3>
                        <div id="pending-requests-list" class="requests-list"></div>
                    </div>
                    
                    <div id="admin-overdue" class="admin-tab-content">
                        <h3>Overdue Books</h3>
                        <div id="overdue-books-list" class="overdue-list"></div>
                    </div>
                    
                    <div id="admin-analytics" class="admin-tab-content">
                        <h3>Library Analytics</h3>
                        <div class="analytics-grid">
                            <div class="analytics-card">
                                <h4>Popular Genres</h4>
                                <div id="genre-chart" class="chart-container" style="position: relative; height: 300px;">
                                    <canvas></canvas>
                                </div>
                            </div>
                            <div class="analytics-card">
                                <h4>Monthly Issues</h4>
                                <div id="monthly-chart" class="chart-container" style="position: relative; height: 300px;">
                                    <canvas></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="admin-users" class="admin-tab-content">
                        <h3>User Management</h3>
                        <div id="users-list" class="users-list"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- PDF Viewer Modal -->
    <div id="pdf-modal" class="modal hidden">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="pdf-title">PDF Viewer</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="pdf-viewer">
                    <p>PDF content would be displayed here. This is a demo version.</p>
                    <div class="pdf-placeholder">
                        <i class="fas fa-file-pdf"></i>
                        <p>PDF Viewer - Demo Mode</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chatbot -->
    <div id="chatbot" class="chatbot">
        <div class="chatbot-header">
            <i class="fas fa-robot"></i>
            <span>AI Assistant</span>
            <button id="chatbot-toggle" class="chatbot-toggle">
                <i class="fas fa-minus"></i>
            </button>
        </div>
        
        <div class="chatbot-body">
            <div id="chatbot-messages" class="chatbot-messages">
                <div class="bot-message">
                    <i class="fas fa-robot"></i>
                    <div class="message-content">
                        Hello! I'm your AI library assistant. I can help you search for books, get recommendations, or answer any library-related questions. How can I help you today?
                    </div>
                </div>
            </div>
            
            <div class="chatbot-input">
                <input type="text" id="chatbot-input-field" placeholder="Ask me anything about books...">
                <button id="chatbot-send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Application Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Database Configuration -->
    <script src="mongodb-config.js"></script>
    <script>
        window.initializeFirebase = async function() {
            try {
                // Wait for Firebase SDK to be loaded
                if (!window.firebase) {
                    throw new Error('Firebase SDK not loaded');
                }
                
                console.log('Initializing Firebase services...');
                
                // Initialize Firebase through our service
                const initialized = await FirebaseService.initialize();
                
                if (!initialized) {
                    throw new Error('Firebase initialization failed');
                }
                
                // Initialize Firestore service
                if (window.FirestoreService) {
                    window.FirestoreService.init();
                }
                
                console.log('Firebase services initialized successfully');
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                document.body.insertAdjacentHTML('afterbegin', `
                    <div style="background: #f8d7da; color: #721c24; padding: 12px; text-align: center;">
                        <strong>Firebase Error:</strong> ${error.message}
                        <button onclick="location.reload()" style="margin-left: 10px; padding: 4px 8px;">
                            🔄 Refresh Page
                        </button>
                    </div>
                `);
                return false;
            }
        };
    </script>
    
    <!-- Application Logic -->
    <script src="openai-config.js"></script>
    <script src="app.js"></script>
    
    <!-- Initialize App -->
    <script>
        const checkFirebaseLoaded = () => {
            return new Promise((resolve) => {
                const check = () => {
                    if (window.firebase && window.firebase.app && 
                        window.firebase.auth && window.firebase.firestore) {
                        resolve(true);
                    } else {
                        setTimeout(check, 100); // Check every 100ms
                    }
                };
                check();
            });
        };

        const initializeApp = async () => {
            console.log('Starting application initialization...');
            
            try {
                // First ensure Firebase SDK is fully loaded
                await checkFirebaseLoaded();
                console.log('Firebase SDK loaded successfully');
                
                // Initialize Firebase
                const maxRetries = 3;
                let retryCount = 0;
                
                while (retryCount < maxRetries) {
                    try {
                        const firebaseInitialized = await window.initializeFirebase();
                        if (firebaseInitialized) {
                            console.log('Application initialized successfully');
                            return true;
                        }
                        throw new Error('Firebase initialization returned false');
                    } catch (error) {
                        retryCount++;
                        console.warn(`Initialization attempt ${retryCount} failed:`, error);
                        
                        if (retryCount === maxRetries) {
                            throw new Error('Failed to initialize after multiple attempts');
                        }
                        
                        // Wait before retrying with exponential backoff
                        await new Promise(resolve => 
                            setTimeout(resolve, Math.min(1000 * Math.pow(2, retryCount), 10000))
                        );
                    }
                }
            } catch (error) {
                console.error('Application initialization error:', error);
                if (window.FirebaseService) {
                    window.FirebaseService.showInitializationError(error);
                } else {
                    // Fallback error display if FirebaseService isn't available
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'background: #f8d7da; color: #721c24; padding: 12px; text-align: center; position: fixed; top: 0; left: 0; right: 0; z-index: 9999;';
                    errorDiv.innerHTML = `
                        <strong>Error:</strong> ${error.message}
                        <button onclick="location.reload()" style="margin-left: 10px; padding: 4px 8px;">
                            🔄 Refresh Page
                        </button>
                    `;
                    document.body.insertBefore(errorDiv, document.body.firstChild);
                }
                return false;
            }
        };

        // Ensure proper initialization timing
        const startInitialization = () => {
            // Remove any existing error messages first
            document.querySelectorAll('.firebase-error, .firebase-warning, .firebase-status')
                .forEach(el => el.remove());
            
            initializeApp().catch(error => {
                console.error('Fatal initialization error:', error);
            });
        };

        // Wait for DOM and then initialize
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', startInitialization);
        } else {
            startInitialization();
        }
    </script>
</body>
</html>